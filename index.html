<!--- Java script and HTML implementation fo the GUI ----------------------->
<!---- Autor: Hans N. Beck  (c) -------------------------------------------->


<!DOCTYPE html >
<html>
<head>
	<meta charset="UTF-8" />
	 <link rel="stylesheet" href="/web/bjstyles.css">

	<script src="/web/jquery-1.11.3.min.js"  type="text/javascript"></script>
	<script src="/web/tau-prolog.js" type="text/javascript"></script>
	<script src="/web/pengines.js" type="text/javascript"></script>
	<script src="/web/p5.min.js" type="text/javascript"></script>

	<script type="text/javascript">
		var result; 
		var roundNo  = 0; 
		var pengine; 
		var session = pl.create(1000);
		var img; 
		var canvas1; 
		var cardwidth = 100; 
		var cardheight = 150;
		var p1X = 15;
		var p1Y = 15 + 15 + cardHeight;

		$(document).ready(init_system());

		// initiate a TauProlog session
		
		function preload() {
  				img = loadImage('/graphics/herzass.png');
		}
		function setup() {
  			canvas1 = createCanvas(800, 345);
  			canvas1.parent('p1Container');

  			noStroke(); 
  			fill(color(240,200,140));
  			rect(0,0,800,300);
  			noStroke(); 
  			fill(color(220,220,220));
  			rect(10,10,780,280);


		}
		
		function draw() {
  		// Displays the image at its actual size at point (0,0)
  			image(img, p1X, 15, cardwidth, cardheight);
  		}
 		
 		function costume(name) {
 			img = loadImage('/graphics/'+name+'.png');
 			console.log('Name is: ' + name);
 		}

		function init_system() {
			$.get("/web/webProlog.pl", function(data) {
				session.consult(data);
		 	});

			// Tau is ready, now pengine
			pengine = new Pengine({
				oncreate: handleCreate, 
				onsuccess: handleOutput,
				destroy: false
			}); 	

			console.log('Init done');
		}
		
		// here are the Pengine handle functions
		function handleCreate() {
			session.query("init.");
			session.answer(printAnswer);
			// call the init of the game
			pengine.ask('playGame(PA2, PP2, Msg)');
		}
		
		function handleOutput(){
			// store the answer into global variable for later analysis
			// in future should be more intelligent. P1 P2 must not be there always
			roundNo = roundNo + 1; 
			var resList = []; 
			for (x in this.data[0])
			{
				// properties must be lowercase later for Tau Prolog
				this.data[0][x.toLowerCase()] = this.data[0][x];
				this.data[0][x].delete;
				resList.push(x.toLowerCase());
			}
			result = this.data[0];
			console.log(result);
			
			session.query("takeResult(["+ resList.toString() + "], result, Term).");
			session.answer(printAnswer);
		}

		// Callback needed for triggering and displaying answers of Tau prolog querys
		var printAnswer = function(answer){
			// Debug code
			//$("#Tauout").append(pl.format_answer(answer));
			//$("#Tauout").append("<br>");
			console.log(answer);
		}

		function sendPengine() {
			var query = $("#Tauhtml").text();
			//var query = 'showDeck(List)'
			console.log("Query will be: " + query)
			pengine.ask(query);
		}

	</script>


	<title> Demo game Black Jack </title>
	
</head>
<body>
	
	<div id="playarea">

		<h1>Demo game Black Jack</h1>
		</p>
		<h3>This simple game is intended as template for projects using SWI Prolog, its Pengines library and Tau-Prolog.</h3>
		
		<button type="button" id="btplay"  >Play Card</button> 
		<button type="button" id="btstop" >Stop</button>
		<p>
		<div id='p1Container'></div>	
		</p>
		<div id="pout"></div>
		<hr>
	</div>
	
	<!-- standard this section is invisible - only for debug -->

	<div id="testblock"> 
		<h4> Test / Debug area </h4>
		<p> The test below queries for a hard coded predicate .</p>

		 Output for Tau Prolog queries. Output is done via callback of the pl.answer function of Tau Prolog.
		 </p>
		 <div id="Tauout"></div>
		 </p>
		 <div id="Tauhtml">Tau terms</div>

	</div>
</p>
	
</body>
</html>