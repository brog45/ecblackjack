<!--- Java script and HTML implementation fo the GUI ----------------------->
<!---- Autor: Hans N. Beck  (c) -------------------------------------------->


<!DOCTYPE html >
<html>
<head>
	 <link rel="stylesheet" href="/web/bjstyles.css">

	<script src="/web/jquery-1.11.3.min.js"  type="text/javascript"></script>
	<script src="/web/tau-prolog.js" type="text/javascript"></script>
	<script src="/web/pengines.js" type="text/javascript"></script>

	<script type="text/javascript">
		var pplayer1;
		var pplayer2;  // the answer of pengine request is stored globally to make things easy
		
		var roundNo  = 0; 
		// initiate a TauProlog session
		var session = pl.create(1000);
		// initate a Pengine 
		var pengine = new Pengine({
			oncreate: handleCreate, 
			onsuccess: handleOutput,
			destroy: false
		}); 

		// here are the Pengine handle functions
		function handleCreate() {
			pengine.ask('playGame(P1, P2, Msg)');
			session.consult("htmlIO.pl");
			session.consult("analyse.pl");
			// load some initial Tau Prolog code
		}
		function handleOutput(){
			// store the answer into global variable for later analysis
			// in future should be more intelligent. P1 P2 must not be there always
			roundNo = roundNo + 1; 

			pplayer1 = this.data[0]["P1"];
			pplayer2 = this.data[0]["P2"];
			pMsg = this. data[0]["Msg"];
			pList = this.data[0]["List"];
			// write output for control into html element
			$("#pout").append(JSON.stringify(pMsg));
			$("#pout").append("<br>");
			$("#pout").append(JSON.stringify(pList));
			$("#pout").append("<br>"); 
			$("#pout").append(playerString());
			$("#pout").append("<br>"); 
			// now bring the answer terms into Tau Prolog
			// we have 2 global JS objects pplayer1 and pplayer2 containing the answer
			session.query("analyse(pplayer1, Player), updatePlayer(Player).");
			session.answer(printAnswer);
			session.query("analyse(pplayer2, Player), updatePlayer(Player).");
			session.answer(printAnswer);

		}

		// Callback needed for triggering and displaying answers of Tau prolog querys
		var printAnswer = function(answer){
			$("#Tauout").append(pl.format_answer(answer));
			$("#Tauout").append("<br>");
			console.log(answer);
		}

		function test() {
			session.query("fact(A,B), writeHTML(fact(A,disc), String).");
			session.answer(printAnswer);
		}
		function gameturn() {
			var players = buildQueryArg();
			var query = 'playCard('+ players[1] + ',' + players[2] + ', P1, P2, Flag,  Msg)';
			//var query = 'showDeck(List)'
			console.log("Query will be: " + query)
			pengine.ask(query);

		}
		function gamestop() {
			var players = buildQueryArg();
			var query = 'stop('+ players[1] + ',' + players[2] + ', _,  Msg)';
			console.log("Query will be: " + query);
			 $("#btplay").prop('disabled', true);
			 $("#btplay").css('background-color','white');
			pengine.ask(query);

		}
		function buildQueryArg() {
			session.query("player(1, A), writeHTML(player(1,A), _).");
			session.answer(); 
			p1 = $("#Tauhtml").text();
			session.query("player(2, A), writeHTML(player(2,A), _).");
			session.answer(); 
			p2 = $("#Tauhtml").text();
			if (roundNo % 2 == 0) 
				return [1, p2, p1] 
			else 
				return [2, p1, p2];
		}

		function playerString(){
			if (roundNo % 2 == 0) 
				return "Player 2, your turn"; 
			else 
				return "Player 1, your turn"; 
		}

	</script>

	<!-- Here some Tau Prolog scripts -->

	<script id="htmlIO.pl" type="text/prolog">
		
		:- use_module(library(dom)).

		fact(world, sphere).

		% +Term : a Tau Prolog term
		% -HMTLString : the term as String
		writeHTML(Term, HTMLString) :-
			get_by_id('Tauhtml', HTML),
			open(HTML, write, Stream), 
			write(Stream, Term),
			close(Stream),
			get_html(HTML, HTMLString).

		% -Term : a Tau Prolog Term
		readHTML(Term) :-
			get_by_id('TauInput', HTML),
			open(HTML, read, Stream), 
			read(Stream, Term),
			clode(Stream).

		nextPlayer(player(1, F1), player(2, F2), player(2, F2), player(1, F1)).

	</script>

	<script id="analyse.pl" type="text/prolog">
		:- use_module(library(dom)).
		:- use_module(library(js)).
		:- use_module(library(lists)).

		% +JSObjectID: an reference to a JS object containing the answer of a Pengine query
		% -TauTerm: the Pengine answer as Tau Prolog Term
		analyse(JSObjectID, TauTerm) :-
			prop('Array', Array),
			prop(JSObjectID, JSObject),
			parseTerm(JSObject, TauTerm),
			writeHTML(TauTerm, String),
			write(String).

		parseTerm(Elem, _) :- var(Elem).

		parseTerm(JSObject, TauTerm) :-
			prop(JSObject, args, ArgList),
			prop(JSObject, functor, Functor),
			parseList(ArgList, TermList),
			append([Functor], TermList, TermList2),
			TauTerm =.. TermList2.

		parseList([], []).

		parseList([Head | Tail ], [Head2 | Tail2]) :-
			(is_list(Head) -> 
				parseList(Head, Head2);
				(atomic(Head) -> 
					Head2 = Head; 
					parseTerm(Head, Head2)
				)
			),
			parseList(Tail, Tail2).

		updatePlayer(player(N, A)) :-
			retractall(player(N, _)),
			asserta(player(N, A)).
		
	</script>

	<title> Demo game Black Jack </title>
	
</head>
<body>
	
	<div id="playarea">

		<h1>Demo game Black Jack</h1>
		</p>
		<h3>This simple game is intended as template for projects using SWI Prolog, its Pengines library and Tau-Prolog.</h3>
		<p>
		If the page is loaded, a pengine query is triggerd (playGame(P1, P2)). This initialise the game and set up both players P1 and P2.  </p>
		</p>
		<button type="button" id="btplay" onclick="javascript:gameturn()" >Play Card</button> 
		<button type="button" id="btstop" onclick="javascript:gamestop()">Stop</button>
		</p>
		</p>
		Output of Pengine
		</p>
		<div id="pout"></div>
		<hr>
	</div>
	<div id="testblock">
		<h4> Test / Debug area </h4>
		<p> The test below queries for a hard coded predicate .</p>

		 Click <a href="javascript:test()"> here </a> for test. The test asks for a hard coded fact <i>fact(world, sphere)</i> by triggering the query <i>"fact(A,B), writeHTML(fact(A,disc), String).</i><br>
		 Output for Tau Prolog queries. Output is done via callback of the pl.answer function of Tau Prolog.
		 </p>
		 <div id="Tauout"></div>
		 </p>
		 Output of Tau terms. Tau Terms are stringified over html element. 
		 </p>
		 <div id="Tauhtml">Tau terms</div>

	</div>
</p>
	
</body>
</html>