<!--- Java script and HTML implementation fo the GUI ----------------------->
<!---- Autor: Hans N. Beck  (c) -------------------------------------------->


<!DOCTYPE html >
<html>
<head>
	<meta charset="UTF-8" />
	 <link rel="stylesheet" href="/web/bjstyles.css">

	<script src="/web/jquery-1.11.3.min.js"  type="text/javascript"></script>
	<script src="/web/tau-prolog.js" type="text/javascript"></script>
	<script src="/web/pengines.js" type="text/javascript"></script>

	<script type="text/javascript">
		var pplayer1;
		var pplayer2;  // the answer of pengine request is stored globally to make things easy
		var result; 
		var roundNo  = 0; 

		// initiate a TauProlog session
		var session = pl.create(10000);
		// initate a Pengine 
		var pengine = new Pengine({
			oncreate: handleCreate, 
			onsuccess: handleOutput,
			destroy: false
		}); 

		// here are the Pengine handle functions
		function handleCreate() {
			 $.get("/web/webProlog.pl", function(data) {
				session.consult(data);
		 	});
			pengine.ask('playGame(P1, P2, Msg)');
			
			// load some initial Tau Prolog code
		}
		
		function handleOutput(){
			// store the answer into global variable for later analysis
			// in future should be more intelligent. P1 P2 must not be there always
			roundNo = roundNo + 1; 
			var resList = []; 
			for (x in this.data[0])
			{
				// properties must be lowercase later for Tau Prolog
				this.data[0][x.toLowerCase()] = this.data[0][x];
				this.data[0][x].delete;
				resList.push(x.toLowerCase());
			}
			result = this.data[0];
			console.log(result);
			
			// write output for control into html element
			// 	$("#pout").append("<br>");
			// $("#pout").append(JSON.stringify(pMsg));
			// $("#pout").append("<br>");
			// $("#pout").append(JSON.stringify(pList));
			// $("#pout").append("<br>"); 
			// $("#pout").append(playerString());
			// $("#pout").append("<br>"); 
			// now bring the answer terms into Tau Prolog
			// we have 2 global JS objects pplayer1 and pplayer2 containing the answer
			//$("#pout").append("Query<br>"); 
			//$("#pout").append("takeResult(["+ resList.toString() + "], result, Term)."); 
			session.query("takeResult(["+ resList.toString() + "], result, Term).");
			session.answer(printAnswer);
		}

		// Callback needed for triggering and displaying answers of Tau prolog querys
		var printAnswer = function(answer){
			$("#Tauout").append(pl.format_answer(answer));
			$("#Tauout").append("<br>");
			console.log(answer);
		}

		function test() {
			session.query("fact(A,B), writeHTML(fact(A,disc), String).");
			session.answer(printAnswer);
		}
		function gameturn() {
			var players = buildQueryArg();
			var query = 'playCard('+ players[1] + ',' + players[2] + ', P1, P2, Flag,  Msg)';
			//var query = 'showDeck(List)'
			console.log("Query will be: " + query)
			pengine.ask(query);

		}
		function gamestop() {
			var players = buildQueryArg();
			var query = 'stop('+ players[1] + ',' + players[2] + ', _,  Msg)';
			console.log("Query will be: " + query);
			 $("#btplay").prop('disabled', true);
			 $("#btplay").css('background-color','white');
			pengine.ask(query);

		}
		function buildQueryArg() {
			session.query("fact(p1, P1), writeHTML('Tauhtml', P1, _).");
			session.answer(); 
			p1 = $("#Tauhtml").text();
			session.query("fact(p2, P2), writeHTML('Tauhtml', P2, _).");
			session.answer(); 
			p2 = $("#Tauhtml").text();
			if (roundNo % 2 == 0) 
				return [1, p2, p1] 
			else 
				return [2, p1, p2];
		}

		function playerString(){
			if (roundNo % 2 == 0) 
				return "Player 2, your turn"; 
			else 
				return "Player 1, your turn"; 
		}

	</script>


	<title> Demo game Black Jack </title>
	
</head>
<body>
	
	<div id="playarea">

		<h1>Demo game Black Jack</h1>
		</p>
		<h3>This simple game is intended as template for projects using SWI Prolog, its Pengines library and Tau-Prolog.</h3>
		<p>
		If the page is loaded, a pengine query is triggerd (playGame(P1, P2)). This initialise the game and set up both players P1 and P2.  </p>
		</p>
		<button type="button" id="btplay" onclick="javascript:gameturn()" >Play Card</button> 
		<button type="button" id="btstop" onclick="javascript:gamestop()">Stop</button>
		</p>
		</p>
		Output of Pengine
		</p>
		<div id="pout"></div>
		<hr>
	</div>
	<div id="testblock">
		<h4> Test / Debug area </h4>
		<p> The test below queries for a hard coded predicate .</p>

		 Click <a href="javascript:test()"> here </a> for test. The test asks for a hard coded fact <i>fact(world, sphere)</i> by triggering the query <i>"fact(A,B), writeHTML(fact(A,disc), String).</i><br>
		 Output for Tau Prolog queries. Output is done via callback of the pl.answer function of Tau Prolog.
		 </p>
		 <div id="Tauout"></div>
		 </p>
		 Output of Tau terms. Tau Terms are stringified over html element. 
		 </p>
		 <div id="Tauhtml">Tau terms</div>

	</div>
</p>
	
</body>
</html>